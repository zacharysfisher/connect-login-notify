<h1>jamf<em>connect</em>notify</h1>

<h2>Overview</h2>

<p>This page will explain how to configure Jamf Connect Login's Notify and Run Script mechanisms (Pluggable Authentication Module) to be used for user provisioning.  This page is geared towards Okta users ONLY.</p>

<h2>Contents</h2>

<ul>
<li>Prestage Package Configuration</li>
<li>Plist Configuration for Jamf Connect Login</li>
<li>RunScript Configuration</li>
<li>Prestage Settings</li>
<li>Okta Configurations for Standard / Admin Users</li>
<li>Deployment</li>
</ul>

<h2>Prestage Package Configuration</h2>

<p>First we need to build our Pre-Stage package to look like the image below:
<a href="Prestage Package Configuration"><img src="https://github.com/zacharysfisher/connect-login-notify/blob/master/images/package_prestage.png" height="250" width="500" ></a>
 As you can see, we are installing both Sync and Login to a temporary location which we will then all to install using the <code>installer</code> binary later in the process.  We are also installing out image files and the notify script location which will also be called later on in this provisioning process.Post Install Script should look like below:
The package also needs a post-install script that will install Login, Sync and activate the Notify and RunScript Mechanisms for us.  Please see below.
```</p>

<h1>!/bin/sh</h1>

<h2>postinstall</h2>

<h1>Install JCL + Sync</h1>

<p>installer -pkg /tmp/Jamf\ Connect\ Login-1.9.0.pkg -target / 
installer -pkg /tmp/Jamf\ Connect\ Sync-1.1.0.pkg -target /</p>

<h1>Enable Notify - Run Script</h1>

<p>/usr/local/bin/authchanger -reset -Okta —DefaultJCRight -preAuth JamfConnectLogin:RunScript,privileged JamfConnectLogin:Notify</p>

<p>exit 0      ## Success
exit 1      ## Failure
```</p>

<p>Once this package is ready for building, make sure that you sign the package and upload it to your distribution points for deployment.</p>

<h2>Plist Configuration for Jamf Connect Login</h2>

<p>Below is an example Plist that we can use with a Custom Settings payload Configuration Profile:</p>

<p><code>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;
&lt;plist version="1.0"&gt;
&lt;dict&gt;
    &lt;key&gt;AuthServer&lt;/key&gt;
    &lt;string&gt;acme.okta.com&lt;/string&gt;
    &lt;key&gt;HelpURL&lt;/key&gt;
    &lt;string&gt;https://acme.okta.com&lt;/string&gt;
    &lt;key&gt;LocalFallback&lt;/key&gt;
    &lt;true/&gt;
    &lt;key&gt;LoginLogo&lt;/key&gt;
    &lt;string&gt;/usr/local/images/company_logo.png&lt;/string&gt;
    &lt;key&gt;OIDCIgnoreCookies&lt;/key&gt;
    &lt;true/&gt;
    &lt;key&gt;OIDCRedirectURI&lt;/key&gt;
    &lt;string&gt;https://127.0.0.1/jamfconnect&lt;/string&gt;
    &lt;key&gt;AllowNetworkSelection&lt;/key&gt;
    &lt;true/&gt;
    &lt;key&gt;CreateSyncPasswords&lt;/key&gt;
    &lt;true/&gt;
    &lt;key&gt;ScriptPath&lt;/key&gt;
    &lt;string&gt;/usr/local/bin/enrollment_script.sh&lt;/string&gt;
    &lt;key&gt;EnableFDE&lt;/key&gt;
    &lt;true/&gt;
&lt;/dict&gt;
&lt;/plist&gt;
</code></p>

<p>Below is an explanation of keys being used</p>

<p>| Key                    | Description                                                            | Example         |
|------------------------|------------------------------------------------------------------------|-----------------|
| AuthServer  | Your Okta base URL for your organization | <code>&lt;key&gt;AuthServer&lt;/key&gt;</code> <code>&lt;string&gt;acme.okta.com&lt;/string&gt;</code> |
| HelpURL     | URL users are directed to when hitting help at login.  This can be a custom page or your okta homepage    | <code>&lt;key&gt;HelpURL&lt;/key&gt;</code> <code>&lt;string&gt;https://acme.okta.com&lt;/string&gt;</code> |
| LocalFallback       | Allows local authentication in case Okta is not reachable    | <code>&lt;key&gt;LocalFallback&lt;/key&gt;</code> <code>&lt;true/&gt;</code> |
| LoginLogo     | Login Logo to be displayed at Jamf Connect Login screen | <code>&lt;key&gt;LoginLogo&lt;/key&gt;</code> <code>&lt;string&gt;/path/to/image.png&lt;/string&gt;</code> |
| OIDCIgnoreCookies     | Ignores any cookies stored by the loginwindow | <code>&lt;key&gt;OIDCIgnoreCookies&lt;/key&gt;</code> <code>&lt;true/&gt;</code> |
| OIDCRedirectURI     | The redirect URI used by your Jamf Connect app in Okta.  "jamfconnect://127.0.0.1/jamfconnect" is recommended by default. | <code>&lt;key&gt;OIDCRedirectURI&lt;/key&gt;</code> <code>&lt;string&gt;https://127.0.0.1/jamfconnect&lt;/string&gt;</code> |
| AllowNetworkSelection     | Allows user to select Wi-Fi network at login window. | <code>&lt;key&gt;AllowNetworkSelection&lt;/key&gt;</code> <code>&lt;true/&gt;</code> |
| CreateSyncPasswords     | Creates a keychain entry for Jamf Connect Sync (requires Sync to be installed already at time of login for this to function | <code>&lt;key&gt;CreateSyncPasswords&lt;/key&gt;</code> <code>&lt;true/&gt;</code> |
| ScriptPath     | Specifies the path to the script or other executable run by the RunScript mechanism. | <code>&lt;key&gt;ScriptPath&lt;/key&gt;</code> <code>&lt;string&gt;/path/to/script.sh&lt;/string&gt;</code> |
| EnableFDE     | Enables Filevault and stores the FV Recovery key locally for Escrow to JAMF Pro (Requires Escrow Configuration Profile to send to JAMF Pro). | <code>&lt;key&gt;CEnableFDE&lt;/key&gt;</code> <code>&lt;true/&gt;</code> |</p>

<p><strong>Please note</strong>
For 10.15 and on, a PCCC Configuration profile is needed.  <a href="https://github.com/zacharysfisher/connect-login-notify/blob/master/images/PCCC_FDE.png">PCCC Payload to allow EnableFDE</a></p>

<h2>RunScript Configuration</h2>

<p>JAMF has good instrutions on how to enable the RunScript mechanism for JAMF Login.  <img src="https://docs.jamf.com/jamf-connect/1.17.0/administrator-guide/Login_Script.html" alt="RunScript Mechanism Documentation" title="" /></p>

<p>You can also follow these instructions using the nano editor.
1. We have actually already enabled our workflow to enable this mechanism by using the <code>authchanger</code> command and to include <code>JamfConnectLogin:RunScript,privileged</code> in our postInstall script.
2. In this script we will tell Notify what to display and what JAMF Policies to run.  See below for an example script:</p>

<p>```</p>

<h1>!/bin/bash</h1>

<h2>#</h2>

<h3>Notify Mechanism Enrollment Script</h3>

<h2>#</h2>

<h1>Variables</h1>

<p>jamfbinary="/usr/local/bin/jamf"</p>

<p>echo "Enrollment Beginning..." >> /tmp/output.txt</p>

<h1>Set a main image</h1>

<h1>Image can be up to 660x105 it will scale up or down proportionally to fit</h1>

<p>echo "Command: Image: /usr/local/images/TTG.png" >> /var/tmp/depnotify.log</p>

<h1>Set the Main Title at the top of the window</h1>

<p>echo "Command: MainTitle: Welcome to your new Mac!" >> /var/tmp/depnotify.log</p>

<h1>Set the Body Text</h1>

<p>echo "Command: MainText: We are setting up a few things for you automatically.\nJust grab a coffee! It won't take long!." >> /var/tmp/depnotify.log</p>

<p>echo "Status: Preparing new machine" >> /var/tmp/depnotify.log </p>

<p>echo "Command: Determinate: 9" >> /var/tmp/depnotify.log
sleep 3
echo "Status: Checking some Magic for you..." >> /var/tmp/depnotify.log </p>

<h1>Checks for presence of JAMF Binary before continuing</h1>

<p>while [ ! -f /usr/local/bin/jamf ]
do
    sleep 2
done</p>

<h3>Jamf Policy Triggers</h3>

<p>sleep 3
echo "Command: Image: /usr/local/images/chrome.png" >> /var/tmp/depnotify.log
echo "Status: Installing Google Chrome" >> /var/tmp/depnotify.log </p>

<p>${jamfbinary} policy -event "google_chrome"</p>

<p>sleep 3
echo "Command: Image: /usr/local/images/slack.png" >> /var/tmp/depnotify.log
echo "Status: Installing Slack" >> /var/tmp/depnotify.log </p>

<p>${jamfbinary} policy -event "slack"</p>

<p>sleep 3
echo "Command: Image: /usr/local/images/CCloud.png" >> /var/tmp/depnotify.log
echo "Status: Installing Creative Cloud Launcher" >> /var/tmp/depnotify.log</p>

<p>${jamfbinary} policy -event "creativecloud"</p>

<p>sleep 3
echo "Command: Image: /usr/local/images/VLC.png" >> /var/tmp/depnotify.log
echo "Status: Installing VLC Media Player" >> /var/tmp/depnotify.log</p>

<p>${jamfbinary} policy -event "vlcplayer"</p>

<p>sleep 3
echo "Command: Image: /usr/local/images/printers.png" >> /var/tmp/depnotify.log
echo "Status: Installing Printer Software" >> /var/tmp/depnotify.log</p>

<p>${jamfbinary} policy -event "printers"</p>

<p>sleep 3
echo "Command: Image: /usr/local/images/security.png" >> /var/tmp/depnotify.log
echo "Status: Configuring Security Settings for your Computer" >> /var/tmp/depnotify.log</p>

<p>${jamfbinary} policy -event "security"</p>

<h1>sleep 3</h1>

<h1>echo "Command: Image: /usr/local/images/Filevault.png" >> /var/tmp/depnotify.log</h1>

<h1>echo "Status: Enabling FileVault Encryption" >> /var/tmp/depnotify.log</h1>

<p>#</p>

<h1>${jamfbinary} policy -event "filevault"</h1>

<h2>#</h2>

<h3>Welcome Screen</h3>

<h2>#</h2>

<p>sleep 5
echo "Command: Image: /usr/local/images/logo.png" >> /var/tmp/depnotify.log
echo "Status: Almost done!" >> /var/tmp/depnotify.log </p>

<h2>#</h2>

<h3>Clean Up</h3>

<h2>#</h2>

<h3>Reset AuthChanger</h3>

<h1>/usr/local/bin/authchanger -reset -Okta —DefaultJCRight</h1>

<p>sleep 3
echo "Command: Quit" >> /var/tmp/depnotify.log</p>

<p>sleep 1
rm -rf /var/tmp/depnotify.log</p>

<p>```</p>

<p>This script displays different images, display text and runs the on-boarding JAMF Policies.  A better explaination of commands that can be run can be found here on JAMF's documentation page. <img src="https://docs.jamf.com/jamf-connect/1.17.0/administrator-guide/Notify_Screen.html" alt="Notify Screen Mechanism" title="" /></p>

<h2>Prestage Settings</h2>

<p>When creating a Prestage Enrollment to work with there are a few settings and configuration profiles that need to be enabled so that Jamf Connect Login gets configured properly.</p>

<ol>
<li>Configuration Profiles (PPPC for Filevault and Jamf Connect Login Settings) should be scoped to these new computers in the <code>Configuration Profiles</code> section of JAMF Pro as well as scoped to the Prestage Enrollment. [Configuration Profiles in Prestage Enrollment] (https://github.com/zacharysfisher/connect-login-notify/blob/master/images/Config<em>Prestage</em>profiles.png)</li>
<li>Attach your Prestage package to the prestage enrollment.</li>
<li>Make sure that no account settings are enabled so that no accounts are created once computer gets enrolled.</li>
<li>The last step is to setup the General Settings tab with information specific to your deployment and select which Setup Assistant options you want to display to the user.</li>
</ol>

<p>Once done, scope this enrollment to your devices.</p>

<h2>Okta Configuration</h2>

<p>If you are using the Plist linked above, no </p>

<h2>Authorization Rules</h2>

<p>| Rule Domain | Description | <br />
|-------------|-------------|
| system.install.software | Checks when the user is installing new software (Pkg, bundled installers)   | 
| system.install.apple-software | Checks when user is installing Apple-provided software |
| system.preferences.network | Checked by the Admin framework when making changes to Network Preferences pane | 
| system.services.systemconfiguration.network | Checks when users edits Network Service settings |
| system.preferences.printing | Checked by the Admin frameowrk when making changes to Printers Preferences pane |
| system.print.operator | LPAdmin Operator Permissions |
| system.print.admin | Checks if user has Printer Admin rights |
| system.preferences.security | Checked by the Admin framework when making changes to the Security preference pane |
| system.preferences.security.remotepair | Used by Bezel Services to gate IR remote pairing. |
| com.apple.DiskManagement.reserveKEK | Used by diskmanagementd to allow use of the reserve KEK |
| system.services.directory.configure | For making Directory Services changes |
| system.preferences.accounts | Checked by the Admin framework when making changes to the Users &amp; Groups preference pane |
| system.csfde.requestpassword | Used by CoreStorage Full Disk Encryption to request the user's password |
| system.preferences | Checked by the Admin framework when making changes to certain System Preferences |
| system.preferences.datetime | Checked by the Admin framework when making changes to the Date &amp; Time preference pane |
| system.preferences.energysaver | Checked by the Admin framework when making changes to the Date Energy Saver pane |
| system.preferences.accessibility | Checked when making changes to the Accessibility Preferences |
| system.install.apple-config-data | Checked when installing Apple Config Data Updates |
| system.privilege.admin | checked when programs request to run a tool as root (e.g., some installers) |
| com.apple.desktopservices | For privileged file operations from within the Finder |
| system.preferences.startupdisk | Checked by the Admin framework when making changes to the Startup Disk preference pane |
| system.preferences.sharing | Checked by the Admin framework when making changes to the Sharing preference pane |</p>

<h2>Deployment</h2>

<p>To deploy the authorization/sudo pam module to machines you need components.
1. A Jamf Pro policy that runs the script in this repository <code>jamfconnect_pam_authorizationWrite_v1.sh</code>.  This can be set to <em>recurring</em> or <em>ongoing</em> frequency depending on your environment.
2. A Jamf Pro Policy that installs auth_file (this has a list of all the authorization rewrites you want to make on the target systems). <code>authorization_list.txt</code> in this repository.  This policy needs to have a custom trigger of <code>authFile</code>, scoped to <code>All Computers</code>, and set to an <code>ongoing</code> frequency.
3. A Jamf Pro policy that installs Jamf Connect Login since that is needed for all of the authorizaiton calls.  In the script in this repository, it uses <em>Jamf Connect Login Trigger</em> as a trigger but this can be changed.
4. A Jamf Pro Configuration profile that pushes the PAM module settings to the client.  Please refer to the <strong>Set Keys for the PAM Module</strong> section for the keys to include.
5. An Okta app that the user must have to make any sudo/authorization requests on the mac.  Refer to <strong>Create an Okta Application to handle Authentication</strong> for configuration.
6. Depending if you use Jamf Connect Login for logging into Macs, you will have to edit the authchanger command or you will have undesirable results.</p>
